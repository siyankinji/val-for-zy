<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Happy Valentine‚Äôs ‚ù§Ô∏è</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Inter", "Segoe UI", Arial, sans-serif;
        position: relative;
        overflow-x: hidden;
        background:
          radial-gradient(
            circle at 15% 20%,
            rgba(255, 255, 255, 0.12) 0,
            transparent 30%
          ),
          radial-gradient(
            circle at 80% 10%,
            rgba(255, 160, 210, 0.18) 0,
            transparent 35%
          ),
          linear-gradient(
            140deg,
            var(--bg-gradient-start),
            var(--bg-gradient-end)
          );
        color: var(--text-main);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 28px 18px;
        isolation: isolate;
      }

      body::selection {
        background: rgba(255, 190, 220, 0.35);
      }

      .ambient-layer {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: -2;
        overflow: hidden;
      }
      .ambient-layer--front {
        z-index: 2;
      }
      .ambient-layer::before {
        content: "";
        position: absolute;
        inset: -30%;
        filter: blur(1);
        background: conic-gradient(
          from 0deg at 50% 50%,
          rgba(255, 132, 183, 0.2),
          rgba(255, 255, 255, 0.06),
          rgba(255, 105, 156, 0.16),
          rgba(255, 132, 183, 0.2)
        );
        animation: gradientSpin 30s linear infinite;
        filter: blur(28px);
        border-radius: 100%;
      }

      .floating-heart {
        position: absolute;
        bottom: -10vh;
        color: rgba(255, 235, 245, 0.7);
        text-shadow: 0 0 14px rgba(255, 128, 177, 0.4);
        animation: rise var(--heart-duration, 12s) linear infinite;
        animation-delay: var(--heart-delay, 0s);
        font-size: var(--heart-size, 1rem);
        opacity: 0;
      }
      .floating-heart--front {
        color: rgba(255, 205, 227, 0.82);
        text-shadow: 0 0 16px rgba(255, 96, 156, 0.5);
      }
      body::before,
      body::after {
        content: "";
        position: fixed;
        width: min(62vw, 420px);
        aspect-ratio: 1;
        border-radius: 999px;
        pointer-events: none;
        z-index: -1;
        opacity: 0.28;
        filter: blur(15px);
      }

      body::before {
        top: -120px;
        left: -120px;
        background: var(--bg-gradient-start);
        animation: floatBlobA 14s ease-in-out infinite alternate;
      }

      body::after {
        right: -140px;
        bottom: -140px;
        background: var(--bg-gradient-end);
        animation: floatBlobB 18s ease-in-out infinite alternate;
      }
      .card {
        width: min(100%, 80vw);
        background: var(--surface);
        border: 1px solid var(--surface-border);
        padding: 30px 24px;
        border-radius: 22px;
        backdrop-filter: blur(12px);
        box-shadow: 0 18px 44px rgba(0, 0, 0, 0.3);
        text-align: center;
        display: flex;
        animation: cardFloat 8s ease-in-out infinite;
      }
      .carddiv {
        width: 100%;
      }
      .cardletter {
        padding: 50px 10px;
        border-radius: 22px;
        backdrop-filter: blur(12px);
      }

      h1 {
        font-size: clamp(2rem, 4.8vw, 3.1rem);
        margin: 0;
        letter-spacing: 0.02em;
      }

      .subtitle {
        margin: 12px auto 0;
        max-width: 640px;
        font-size: 1rem;
        line-height: 1.7;
        color: var(--text-soft);
        text-align: start;
      }

      h2 {
        margin: 30px 0 12px;
        font-size: 1.3rem;
      }

      .gallery {
        margin-top: 8px;
      }

      .slideshow {
        position: relative;
        width: min(100%, 760px);
        margin: 0 auto;
        border-radius: 18px;
        overflow: hidden;
        aspect-ratio: 4/3;
        background: rgba(0, 0, 0, 0.24);
        border: 1px solid rgba(255, 255, 255, 0.22);
      }

      .slide {
        position: absolute;
        inset: 0;
        opacity: 0;
        transition: opacity 0.45s ease;
        pointer-events: none;
      }
      .slide.active {
        opacity: 1;
        pointer-events: auto;
      }
      .slide img,
      .slide video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .dots {
        display: flex;
        justify-content: center;
        gap: 9px;
        margin-top: 12px;
        flex-wrap: wrap;
      }

      .dot {
        aspect-ratio: 2 / 1;
        width: 12px;
        border-radius: 50px;
        border: 0;
        background: #ffffff78;
        transition: all ease 1s;
      }

      .dot.active {
        background: var(--dot-active);
        aspect-ratio: 10 / 1;
        width: 50px;
        background: white;
        transition: all ease 1s;
      }

      .gallery-status {
        margin-top: 12px;
        font-size: 0.94rem;
        color: var(--text-soft);
      }

      #autoplayHint {
        font-size: 0.9rem;
        color: var(--text-soft);
      }
      .m-0-50 {
        margin: 0 50px;
      }
      @keyframes floatBlobA {
        0% {
          transform: translate3d(0, 0, 0) scale(1);
        }
        100% {
          transform: translate3d(90px, 55px, 0) scale(1.15);
        }
      }
      @keyframes cardFloat {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-5px);
        }
      }

      @keyframes gradientSpin {
        to {
          transform: rotate(1turn);
        }
      }

      @keyframes rise {
        0% {
          transform: translate3d(0, 0, 0) scale(0.9);
          opacity: 0;
        }
        15% {
          opacity: 0.65;
        }
        100% {
          transform: translate3d(var(--heart-drift, 0px), -120vh, 0) scale(1.25);
          opacity: 0;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        .card,
        body::before,
        body::after,
        .floating-heart,
        .ambient-layer::before {
          animation: none !important;
        }
      }

      @keyframes floatBlobB {
        0% {
          transform: translate3d(0, 0, 0) scale(1);
        }
        100% {
          transform: translate3d(-75px, -45px, 0) scale(1.12);
        }
      }

      @media (max-width: 640px) {
        .card {
          width: min(100%, 90vw);
          padding: 24px 16px;
          border-radius: 18px;
          flex-direction: column;
        }
        .m-0-50 {
          margin: 0;
        }
        h2 {
          margin-top: 24px;
        }
      }
    </style>
  </head>
  <body>
    <div class="ambient-layer" id="ambientLayer" aria-hidden="true"></div>
    <div
      class="ambient-layer ambient-layer--front"
      id="foregroundHeartLayer"
      aria-hidden="true"
    ></div>
    <div class="card">
      <div class="carddiv cardletter">
        <h1>Dear Meyaaa ‚ù§Ô∏è</h1>
        <p class="subtitle">
          <b>
            <br />
            Happy Valentine‚Äôs Day, Mae.<br />
          </b>
          <br />
          If there‚Äôs one thing I‚Äôm sure about, it‚Äôs that I‚Äôll always be grateful
          for you. For every month we survived, every away we fixed, every
          laugh, every random sabaw moment, and every time we still chose each
          other kahit mahirap.<br />
          <br />
          Like Taylor said‚Ä¶
          <b>‚ÄúI had the time of my life fighting dragons with you.‚Äù</b><br />
          And Mi, I swear, ikaw yung favorite battle ko. Not because it was
          easy, but because it was always <i>worth it</i> and because ikaw na
          yan ih.<br />
          <br />
          We had our own little kingdom <br />
          our BGC days, museum dates, ice skating, random Roblox nights, tiktok
          spam, late talks, and even those times na tahimik lang but it still
          felt safe because it‚Äôs you.<br />
          <br />
          And even if someday everything changes, I want you to know this:<br />
          <br />
          <b>Long live all the magic we made.</b><br />
          Long live the memories we keep building.<br />
          Long live us still figuring things out, still trying, still loving.<br />
          <br />
          Thank you for staying.<br />
          Thank you for being my peace, my home, my favorite person.<br />
          <br />
          Happy Valentine‚Äôs Day, Leoneil Mae Bacasong Reyes.<br />
          I love you, always.<br />
          <br />
          ‚Äì Grayyy ‚ù§Ô∏è
        </p>
      </div>

      <div class="carddiv m-0-50">
        <div class="gallery">
          <p id="galleryStatus" class="gallery-status">Loading memories‚Ä¶</p>
          <div id="slideshow" class="slideshow" aria-live="polite"></div>
          <div id="dots" class="dots" aria-label="Slideshow pagination"></div>
        </div>
        <h2>Song reminds me of us</h2>
        <div id="spotifyMount" style="margin-top: 15px"></div>
        <p id="autoplayHint">
          (If it doesn't play automatically, tap the button again üíñ)
        </p>
      </div>
      <script src="https://open.spotify.com/embed/iframe-api/v1" async></script>
    </div>

    <script>
      const FIREBASE_DB_URL =
        "https://for-mae-default-rtdb.asia-southeast1.firebasedatabase.app";
      const IMAGE_EXT = /\.(png|jpe?g|gif|webp|bmp|svg)(\?.*)?$/i;
      const VIDEO_EXT = /\.(mp4|webm|ogg|mov)(\?.*)?$/i;

      const mount = document.getElementById("spotifyMount");
      const autoplayHint = document.getElementById("autoplayHint");
      const slideshow = document.getElementById("slideshow");
      const dotsWrap = document.getElementById("dots");
      const galleryStatus = document.getElementById("galleryStatus");
      const trackId = "7KD8oUUpidul2ROxTIhPAw";
      const ambientLayer = document.getElementById("ambientLayer");
      const foregroundHeartLayer = document.getElementById(
        "foregroundHeartLayer",
      );
      let spotifyController = null;
      let slideTimer = null;

      const fallbackPalette = {
        bgStart: "#2e1328",
        bgEnd: "#5f1f3a",
        surface: "rgba(255, 255, 255, 0.1)",
        surfaceBorder: "rgba(255, 255, 255, 0.28)",
        textMain: "#fff7fb",
        textSoft: "rgba(255, 247, 251, 0.85)",
        accent: "#ff4f83",
        accentHover: "#ff2f71",
      };

      const isColorLike = (value) =>
        typeof value === "string" && value.trim().length > 0;

      function applyPalette(palette) {
        if (!palette || typeof palette !== "object") return;
        const rootStyle = document.documentElement.style;

        const map = [
          ["--bg-gradient-start", palette.bgStart],
          ["--bg-gradient-end", palette.bgEnd],
          ["--surface", palette.surface],
          ["--surface-border", palette.surfaceBorder],
          ["--text-main", palette.textMain],
          ["--text-soft", palette.textSoft],
          ["--accent", palette.accent],
          ["--accent-hover", palette.accentHover],
          ["--dot", palette.dot],
          ["--dot-active", palette.dotActive],
        ];

        map.forEach(([key, value]) => {
          if (isColorLike(value)) rootStyle.setProperty(key, value.trim());
        });
      }

      function normalizePalette(data) {
        const raw =
          data?.palette ||
          data?.colors ||
          data?.theme ||
          data?.valentine2?.palette ||
          data?.valentine2?.colors ||
          data;

        if (!raw || typeof raw !== "object") return null;

        return {
          bgStart: raw.bgStart || raw.backgroundStart || raw.background1,
          bgEnd: raw.bgEnd || raw.backgroundEnd || raw.background2,
          surface: raw.surface || raw.card || raw.cardBackground,
          surfaceBorder:
            raw.surfaceBorder || raw.cardBorder || raw.border || raw.outline,
          textMain: raw.textMain || raw.text || raw.primaryText,
          textSoft: raw.textSoft || raw.secondaryText || raw.mutedText,
          accent: raw.accent || raw.button || raw.primary,
          accentHover: raw.accentHover || raw.buttonHover || raw.primaryHover,
          dot: raw.dot,
          dotActive: raw.dotActive,
        };
      }

      async function initFirebasePalette() {
        const palettePaths = [
          "valentine2/palette",
          "valentine2/theme",
          "palette/valentine2",
        ];

        for (const path of palettePaths) {
          try {
            const res = await fetch(`${FIREBASE_DB_URL}/${path}kenji.json`, {
              cache: "no-store",
            });

            if (!res.ok) continue;

            const data = await res.json();
            const palette = normalizePalette(data);
            if (palette) {
              applyPalette({ ...fallbackPalette, ...palette });
              return;
            }
          } catch (error) {
            console.warn(`[Palette] Could not load ${path}`, error);
          }
        }

        applyPalette(fallbackPalette);
      }

      const normalizeMedia = (
        raw,
        fallbackOrder = Number.POSITIVE_INFINITY,
      ) => {
        if (!raw) return null;
        if (typeof raw === "string") {
          const src = raw.trim();
          if (!src) return null;
          return {
            src,
            type: VIDEO_EXT.test(src) ? "video" : "image",
            sortOrder: fallbackOrder,
          };
        }

        const src = typeof raw.src === "string" ? raw.src.trim() : "";
        if (!src) return null;
        const explicitType = typeof raw.type === "string" ? raw.type : "";
        const guessedType = VIDEO_EXT.test(src)
          ? "video"
          : IMAGE_EXT.test(src)
            ? "image"
            : "image";

        const rawOrder = Number(raw.sortOrder);
        const sortOrder =
          Number.isFinite(rawOrder) && rawOrder > 0 ? rawOrder : fallbackOrder;

        return {
          src,
          type:
            explicitType === "video" || explicitType === "image"
              ? explicitType
              : guessedType,
          sortOrder,
        };
      };

      const parseJsonIfString = (value) => {
        if (typeof value !== "string") return value;
        const trimmed = value.trim();
        if (!trimmed) return value;
        if (!(trimmed.startsWith("{") || trimmed.startsWith("["))) {
          return value;
        }

        try {
          return JSON.parse(trimmed);
        } catch {
          return value;
        }
      };

      const toAssetList = (input) => {
        if (Array.isArray(input)) {
          return input.map((item, index) => ({
            item,
            fallbackOrder: index + 1,
          }));
        }

        if (input && typeof input === "object") {
          return Object.entries(input).map(([, item], index) => ({
            item,
            fallbackOrder: index + 1,
          }));
        }

        return [];
      };

      async function fetchSlideshowData() {
        const res = await fetch(
          `${FIREBASE_DB_URL}/valentine2/slideshow.json`,
          {
            cache: "no-store",
          },
        );

        if (!res.ok) {
          throw new Error(`Failed to load slideshow data (${res.status})`);
        }

        const data = parseJsonIfString(await res.json());
        const slideshowData = parseJsonIfString(data?.slideshow) || data;
        const assetsSource =
          slideshowData?.assets ??
          slideshowData?.items ??
          data?.assets ??
          data?.items ??
          data;
        const assets = toAssetList(assetsSource);
        const intervalRaw =
          slideshowData?.intervalMs ??
          data?.intervalMs ??
          data?.slideshowIntervalMs;

        const normalizedAssets = assets
          .map(({ item, fallbackOrder }) => normalizeMedia(item, fallbackOrder))
          .filter(Boolean)
          .sort((a, b) => a.sortOrder - b.sortOrder);

        return {
          assets: normalizedAssets,
          intervalMs:
            Number.isFinite(Number(intervalRaw)) && Number(intervalRaw) >= 2000
              ? Number(intervalRaw)
              : 5000,
        };
      }

      function setGalleryStatus(message) {
        if (galleryStatus) galleryStatus.textContent = message;
      }

      function renderSlideshow(items, intervalMs) {
        if (!slideshow || !dotsWrap) return;
        slideshow.innerHTML = "";
        dotsWrap.innerHTML = "";
        if (slideTimer) {
          clearInterval(slideTimer);
          slideTimer = null;
        }

        if (!items.length) {
          setGalleryStatus(
            "No memories yet. Add assets in Firebase to display them.",
          );
          return;
        }

        const slideElements = items.map((item) => {
          const slide = document.createElement("div");
          slide.className = "slide";

          const media = document.createElement(
            item.type === "video" ? "video" : "img",
          );
          media.src = item.src;
          media.setAttribute("aria-hidden", "true");

          if (item.type === "video") {
            media.muted = true;
            media.playsInline = true;
            media.preload = "metadata";
            media.loop = true;
          } else {
            media.alt = "Memory";
            media.loading = "lazy";
          }

          slide.appendChild(media);
          slideshow.appendChild(slide);
          return slide;
        });

        const dots = slideElements.map((_, index) => {
          const dot = document.createElement("button");
          dot.type = "button";
          dot.className = "dot";
          dot.setAttribute("aria-label", `Show slide ${index + 1}`);
          dot.addEventListener("click", () => activate(index));
          dotsWrap.appendChild(dot);
          return dot;
        });

        let current = 0;

        function activate(index) {
          current = index;
          slideElements.forEach((slide, i) => {
            const isActive = i === index;
            slide.classList.toggle("active", isActive);
            dots[i].classList.toggle("active", isActive);

            const video = slide.querySelector("video");
            if (!video) return;

            if (isActive) {
              try {
                video.currentTime = 0;
              } catch (error) {
                console.warn("Unable to reset video time", error);
              }
              video.play().catch(() => {});
            } else {
              video.pause();
            }
          });
        }

        activate(0);
        setGalleryStatus(`‚ÄúI picked ${items.length} memories for you :>
Some are photos, some are videos, and some are little moments I never want to forget.
I hope when you see them, you‚Äôll feel how much I love you. ü•∫‚ù§Ô∏è‚Äù `);

        if (slideElements.length > 1) {
          slideTimer = setInterval(() => {
            activate((current + 1) % slideElements.length);
          }, intervalMs);
        }
      }

      async function initFirebaseSlideshow() {
        try {
          const { assets, intervalMs } = await fetchSlideshowData();
          renderSlideshow(assets, intervalMs);
        } catch (error) {
          console.error("[Slideshow]", error);
          setGalleryStatus("Could not load Firebase slideshow right now.");
        }
      }

      function createFloatingHearts() {
        if (!ambientLayer) return;

        const heartCount = window.innerWidth < 640 ? 30 : 50;
        const heartChar = [
          "‚ù§",
          "‚ô°",
          "üíñ",
          "üå∑",
          "",
          "üíï",
          "Beatzyyyyy",
          "I love you",
        ];

        ambientLayer.innerHTML = "";
        if (foregroundHeartLayer) foregroundHeartLayer.innerHTML = "";

        for (let index = 0; index < heartCount; index += 1) {
          const heart = document.createElement("span");
          heart.className = "floating-heart";
          heart.textContent =
            heartChar[Math.floor(Math.random() * heartChar.length)];

          heart.style.left = `${Math.random() * 100}%`;
          heart.style.setProperty(
            "--heart-size",
            `${0.8 + Math.random() * 1.4}rem`,
          );
          heart.style.setProperty("--heart-delay", `${Math.random() * 10}s`);
          heart.style.setProperty(
            "--heart-duration",
            `${9 + Math.random() * 10}s`,
          );
          heart.style.setProperty(
            "--heart-drift",
            `${-80 + Math.random() * 160}px`,
          );

          const isForegroundHeart = Math.random() < 0.28;
          const targetLayer =
            isForegroundHeart && foregroundHeartLayer
              ? foregroundHeartLayer
              : ambientLayer;

          if (isForegroundHeart) {
            heart.classList.add("floating-heart--front");
          }

          targetLayer.appendChild(heart);
        }
      }

      const hideAutoplayHint = () => {
        if (autoplayHint) autoplayHint.style.display = "none";
      };

      const attemptSpotifyPlay = () => {
        if (!spotifyController) return;

        try {
          spotifyController.play();
        } catch (error) {
          console.error("[Spotify] Autoplay failed:", error);
        }
      };

      const initSpotifyEmbed = (IFrameAPI) => {
        if (!mount || !trackId) return;

        mount.innerHTML = "";
        IFrameAPI.createController(
          mount,
          { uri: `spotify:track:${trackId}`, width: "100%", height: 152 },
          (EmbedController) => {
            spotifyController = EmbedController;

            attemptSpotifyPlay();

            EmbedController.addListener("playback_started", () => {
              hideAutoplayHint();
            });

            EmbedController.addListener("playback_update", (event) => {
              if (event?.data && !event.data.isPaused) {
                hideAutoplayHint();
              }
            });
          },
        );
      };

      window.onSpotifyIframeApiReady = (IFrameAPI) => {
        window.__SpotifyIFrameAPI = IFrameAPI;
        initSpotifyEmbed(IFrameAPI);
      };

      if (window.__SpotifyIFrameAPI) {
        initSpotifyEmbed(window.__SpotifyIFrameAPI);
      }
      createFloatingHearts();
      window.addEventListener("resize", createFloatingHearts);
      initFirebasePalette();
      initFirebaseSlideshow();
    </script>
  </body>
</html>
